---
title: "Weekly Ambience and Sleep"
date: "`r format(Sys.Date(),'%b %d, %Y')`"
output: html_document
knit: (function(input, encoding) {
  rmarkdown::render(input,
                    output_dir = "../output")})
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(include = TRUE,echo=FALSE,warning = FALSE,message=FALSE)


library(plotly)
library(dplyr)
library(rjson)

setwd(file.path("~","Documents","projects","ambience_reports","weekly_sleep"))
amb_dataset = read.csv(file.path("intermediate_data","temp_ambience.csv"))
#sleep_dataset = fromJSON(file.path("intermediate_data","oura_sleep_2024-08-04T19-54-06.json"),flatten = T)

amb_dataset$reading_dttm = as.POSIXct(amb_dataset$reading_dttm)
amb_dataset = amb_dataset %>% arrange(reading_dttm)

x_lower = as.POSIXct(paste0(format(min(amb_dataset$reading_dttm),"%Y-%m-%d")," 12:00"))
x_upper = as.POSIXct(paste0(format(max(amb_dataset$reading_dttm),"%Y-%m-%d")," 12:00"))

sleepJson = fromJSON(file=file.path("intermediate_data","oura_sleep_2024-08-04T19-54-06.json"))

dateList = seq(as.Date(format(x_lower,"%Y-%m-%d")),as.Date(format(x_upper,"%Y-%m-%d")),by="1 day")

indices = which(sapply(sleepJson$sleep,function(x){x["day"] %in% as.character(dateList)}))
wha = lapply(
  sleepJson$sleep[indices]
  ,function(x){data.frame(
    "date"=x["day"][[1]]
    ,"start"= x["bedtime_start"][[1]]
    ,"end"=x["bedtime_end"][[1]]
    )}
  )
bedtimes = do.call(rbind,wha)
bedtimes$start = as.POSIXct(bedtimes$start,format="%Y-%m-%dT%H:%M:%S.000%OS")
bedtimes$end = as.POSIXct(bedtimes$end,format="%Y-%m-%dT%H:%M:%S.000%OS")

#read in sleep scores
sleep_scores = read.csv(file.path("intermediate_data","oura_daily-sleep_2024-08-04T18-49-07.csv"),header = TRUE)

plot_sleep_data = left_join(bedtimes,sleep_scores,by=c("date" = "day")) %>%
  # remove sleep data outside of the week's limits
  filter(x_lower < start & end < x_upper) 

```

## Plots {.tabset}

The images below below are the combined results of two systems:  

* the measurements that I record as part of my [ambience database](https://snyderjo.github.io/ambience/), and  
* my sleep patterns as recorded by a wearable device.  

My hope is to identify how temperature and humidity affect my sleep, and adjust them accordingly--god help me if pressure affects my sleep.  

The blue boxes represent the beginning and end of a night's sleep.  The sleep score is represented twice-over: once as the opacity of the box (more opaque is a lower score), and second in a tooltip near the top of it's respective box.  

### Temperature  

```{r Temperature, echo=FALSE}
y_box_top = max(amb_dataset$temp)
y_box_bottom = min(amb_dataset$temp)


fig = plot_ly(data = amb_dataset, x = ~reading_dttm) 

for (i in 1:nrow(plot_sleep_data)) fig <- fig %>% 
  
  add_polygons(
    x = c(plot_sleep_data$start[i],plot_sleep_data$end[i],plot_sleep_data$end[i],plot_sleep_data$start[i])
    ,y = c(y_box_top,y_box_top,y_box_bottom,y_box_bottom)
    ,color = I("blue")
    ,opacity = plot_sleep_data$score[i]/100
    ,line=list(width=0)
    ,name=as.character(plot_sleep_data$score[i])
    #,hoverinfo = plot_sleep_data$score[i]
    ,inherit = FALSE
    ,showlegend = FALSE
  )


fig = fig %>% add_lines(y = ~temp,color = I("red"))
fig = fig %>% layout(
    title = NULL,
    xaxis = list(
      range=c(x_lower,x_upper)
      ,title = "date-time"
      ,rangeslider = list(type = "dateteime")
      ),
    yaxis = list(title = "Temperature (C)"))

fig
```

Some of you might be asking: *Does it really get above 40 (104 degrees Fahrenheit) in your bedroom???*  
No.  The sensor is attached to a raspberry pi, which produces a good amount of heat on its own.  The above data measures temperature with a consistent bias.

### Humidity  

```{r humidity, echo=FALSE}

y_box_top = max(amb_dataset$humidity)
y_box_bottom = min(amb_dataset$humidity)

fig = plot_ly(data = amb_dataset, x = ~reading_dttm) 

for (i in 1:nrow(plot_sleep_data)) fig <- fig %>% 
  add_polygons(
    x = c(plot_sleep_data$start[i],plot_sleep_data$end[i],plot_sleep_data$end[i],plot_sleep_data$start[i])
    ,y = c(y_box_top,y_box_top,y_box_bottom,y_box_bottom)
    ,color = I("blue")
    ,opacity = plot_sleep_data$score[i]/100
    ,line=list(width=0)
    ,name=as.character(plot_sleep_data$score[i])
    #,hoverinfo = plot_sleep_data$score[i]
    ,inherit = FALSE
    ,showlegend = FALSE
  )

fig = fig %>% add_lines(y = ~humidity,color = I("orange"))
fig = fig %>% layout(
    title = NULL,
    xaxis = list(
      range=c(x_lower,x_upper)
      ,title = "date-time"
      ,rangeslider = list(type = "dateteime")
      ),
    yaxis = list(title = "Humidity (%)")
    )

fig


```

### Pressure  

```{r pressure, echo=FALSE}
y_box_top = max(amb_dataset$pressure)
y_box_bottom = min(amb_dataset$pressure)


fig = plot_ly(data = amb_dataset, x = ~reading_dttm) 

for (i in 1:nrow(plot_sleep_data)) fig <- fig %>% 
  add_polygons(
    x = c(plot_sleep_data$start[i],plot_sleep_data$end[i],plot_sleep_data$end[i],plot_sleep_data$start[i])
    ,y = c(y_box_top,y_box_top,y_box_bottom,y_box_bottom)
    ,color = I('blue')
    ,opacity = plot_sleep_data$score[i]/100
    ,line=list(width=0)
    ,name=as.character(plot_sleep_data$score[i])
    #,hoverinfo = plot_sleep_data$score[i]
    ,inherit = FALSE
    ,showlegend = FALSE
  )

fig = fig %>% add_lines(y = ~pressure,color = I("green"))
fig = fig %>% layout(
    title = NULL,
    xaxis = list(
      range = c(x_lower, x_upper)
      ,title = "date-time"
      ,rangeslider = list(type = "dateteime")
      ),
    yaxis = list(title = "Pressure (mbar)")
    )

fig


```


## A couple of notes:


* What gives with the delay between the date this report is rendered vs. what is displayed below?  
  + If the data were immediate, it would be entirely too clear when I was out of town--information I'm not keen to share.  
* There are notable gaps in data.  Why?  
   + Some nights, I forget to put on the wearable.  
   + Some days the [DAG](https://airflow.apache.org/docs/apache-airflow/1.10.9/concepts.html) fails for no discerable reason--I invite you to take it up with Apache.  
   + Sometimes, the device itself simply fails to record. ¯\\\_(ツ)\_/¯  


